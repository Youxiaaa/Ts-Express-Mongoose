(()=>{"use strict";var e={752:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(860)),r=s(582),u=o(s(440)),d=(0,a.default)();d.use(r({origin:["https://ryanyou.com","http://localhost:3000"],methods:"GET,PUT,POST,DELETE",allowedHeaders:["Content-Type","Authorization"]})),d.use(a.default.json()),d.use("/uploads",a.default.static("uploads")),d.use("/todos",u.default.todoRouter),d.use("/user",u.default.userRouter),d.use("/file",u.default.uploadRouter),d.listen(3001,(()=>{console.log("server is running on 3001 port and already to service")}))},443:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(185));a.default.set("strictQuery",!1),a.default.connect("mongodb://127.0.0.1:27017/demoDB").then((()=>console.log("Connect to MongoDB"))).catch((e=>console.log("Failed to connect MongoDB",e))),t.default=a.default},1:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(217)),r=o(s(805)),u=o(s(563));t.default={todoController:a.default,userController:r.default,uploadController:u.default}},217:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(970));t.default={add:async(e,t)=>{try{const s=new a.default({title:e.body.title,isCompleted:!1});await s.save();const o=await a.default.find({deletedAt:{$eq:null}},"title isCompleted");t.status(201).send({code:201,message:"新增todos成功",todos:o})}catch(e){t.status(401).send({code:401,message:"新增todos失敗"})}},get:async(e,t)=>{try{const e=await a.default.find({deletedAt:{$eq:null}},"title isCompleted");t.status(200).send({code:200,todos:e,message:"取得todos成功"})}catch(e){t.status(400).send({code:400,message:"取得todos失敗"})}},update:async(e,t)=>{if(await a.default.findOne({$and:[{_id:{$eq:e.body.id}},{deletedAt:{$eq:null}}]}))t.status(401).send({code:401,message:"修改todo失敗"});else try{await a.default.updateOne({_id:e.params.id},e.body);const s=await a.default.find({deletedAt:{$eq:null}},"title isCompleted");t.status(201).send({code:201,message:"修改todo成功",todos:s})}catch(e){t.status(401).send({code:401,message:"修改todo失敗"})}},delete:async(e,t)=>{if(!await a.default.findOne({$and:[{_id:{$eq:e.params.id}},{deletedAt:{$eq:null}}]}))return t.status(401).send({code:401,message:"刪除todo失敗"});try{await a.default.updateOne({_id:`${e.params.id}`},{deletedAt:new Date});const s=await a.default.find({deletedAt:{$eq:null}},"title isCompleted");t.status(201).send({code:201,message:"刪除todo成功",todos:s})}catch(e){t.status(401).send({code:401,message:"刪除todo失敗"})}}}},563:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(902));t.default={upload:async(e,t)=>{try{new a.default({filename:e.file.filename,filetype:e.file.mimetype,path:e.file.path}).save().then((e=>{t.status(201).json({code:201,message:"上傳檔案成功",result:e.path})})).catch((e=>{t.status(400).json({code:400,message:e._message})}))}catch(s){e.fileValidationError?t.status(400).send({code:400,message:e.fileValidationError}):t.status(400).send({code:400,message:s})}}}},805:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(309)),r=s(96),u=s(344);t.default={register:async(e,t)=>{try{const{username:s,password:o}=e.body;if(await a.default.findOne({username:s}))return t.status(401).send({code:401,message:"已有此使用者名稱"});const u=new a.default({username:s,password:o});return u.password=await r.hash(o,10),await u.save(),t.status(201).send({code:201,message:"建立會員成功"})}catch(e){return t.status(422).send({code:422,message:e})}},login:async(e,t)=>{try{const{username:s,password:o}=e.body,d=await a.default.findOne({username:s});if(!d)return t.status(401).send({code:401,message:"帳號或密碼錯誤"});if(!await r.compare(o,d.password))return t.status(401).send({code:401,message:"帳號或密碼錯誤"});const n=u.sign({userId:d._id,type:"accessToken"},"secret",{expiresIn:"1h"}),l=u.sign({userId:d._id,type:"refreshToken"},"refreshSecret",{expiresIn:"1d"});return t.status(200).send({code:200,message:"登入成功",accessToken:n,refreshToken:l})}catch(e){return t.status(422).send({code:422,message:e})}},refreshToken:async(e,t)=>{const{refreshToken:s}=e.body;if(s){const e=await async function(e){try{return!!await u.verify(e,"refreshSecret")}catch(e){return!1}}(s);if(e){const e=await u.verify(s,"refreshSecret"),o=u.sign({userId:e.userId,type:"accessToken"},"secret",{expiresIn:"1h"}),a=u.sign({userId:e.userId,type:"refreshToken"},"refreshSecret",{expiresIn:"1d"});return t.status(200).send({code:200,message:"刷新Token成功",access_token:o,refresh_token:a})}return t.status(401).send({code:401,message:"刷新Token失敗"})}return t.status(401).send({code:401,message:"拒絕訪問"})}}},343:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.verifyJWT=void 0;const o=s(344);t.verifyJWT=function(e,t,s){try{if(!e.headers.authorization)return t.status(401).send({code:401,message:"拒絕訪問"});{const a=e.headers.authorization.split(" ")[1];if(!a)return t.status(401).send({code:401,message:"拒絕訪問"});const r=o.verify(a,"secret");e.user=r,s()}}catch(e){return t.status(401).send({code:401,message:e.message})}}},843:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=s(343),a=s(480),r=s(311);t.default={verifyJWT:o.verifyJWT,filterLanguege:a.filterLanguege,upload:r.upload}},480:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.filterLanguege=void 0;const s=["fuck","fuckyou","ass"];t.filterLanguege=function(e,t,o){Object.values(e.body).forEach((e=>{(e=e.replace(/\s*/g,""))?s.includes(e)?t.status(401).send({code:401,message:"字串包含不雅文字"}):o():t.status(401).send({code:401,message:"字串不可為空"})}))}},311:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.upload=void 0;const a=o(s(635)),r=s(147),u=s(738),d=u.diskStorage({destination:function(e,t,s){const o="./uploads/";r.existsSync(o)||r.mkdirSync(o),s(null,o)},filename:function(e,t,s){s(null,`${(0,a.default)().format("YYYYMMDDhhmmss")}-${t.originalname}`)}});t.upload=u({storage:d,limits:{fileSize:5242880},fileFilter:(e,t,s)=>{"image/jpeg"===t.mimetype||"image/png"===t.mimetype?s(null,!0):(e.fileValidationError="檔案格式不正確",s(null,!1,e.fileValidationError))}})},902:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(443)),r=new a.default.Schema({filename:{type:String,required:!0},filetype:{type:String,required:!0},path:{type:String,required:!0}}),u=a.default.model("File",r);t.default=u},970:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(443)),r=new a.default.Schema({title:{type:String,require:!0},isCompleted:{type:Boolean,require:!0},deletedAt:{type:Date,default:null}},{timestamps:!0}),u=a.default.model("Todos",r);t.default=u},309:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(443)),r=new a.default.Schema({username:{type:String,required:!0,unique:!0},password:{type:String,required:!0}}),u=a.default.model("Users",r);t.default=u},440:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(s(981)),r=o(s(875)),u=o(s(325));t.default={todoRouter:a.default,userRouter:r.default,uploadRouter:u.default}},981:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(860),r=o(s(1)),u=o(s(843)),d=(0,a.Router)();d.get("/get",u.default.verifyJWT,r.default.todoController.get),d.post("/add",u.default.verifyJWT,u.default.filterLanguege,r.default.todoController.add),d.put("/update/:id",u.default.verifyJWT,r.default.todoController.update),d.delete("/delete/:id",u.default.verifyJWT,r.default.todoController.delete),t.default=d},325:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(860),r=o(s(1)),u=o(s(843)),d=(0,a.Router)();d.post("/upload",u.default.verifyJWT,u.default.upload.single("file"),r.default.uploadController.upload),t.default=d},875:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(860),r=o(s(1)),u=(0,a.Router)();u.post("/register",r.default.userController.register),u.post("/login",r.default.userController.login),u.post("/refreshToken",r.default.userController.refreshToken),t.default=u},96:e=>{e.exports=require("bcrypt")},582:e=>{e.exports=require("cors")},635:e=>{e.exports=require("dayjs")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},738:e=>{e.exports=require("multer")},147:e=>{e.exports=require("fs")}},t={};!function s(o){var a=t[o];if(void 0!==a)return a.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,s),r.exports}(752)})();